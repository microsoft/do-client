# This Yaml Document has been converted by ESAI Yaml Pipeline Conversion Tool.
# Please make sure to check all the converted content, it is your team's responsibility to make sure that the pipeline is still valid and functions as expected.
# The Task 'PublishBuildArtifacts@1' has been converted to an output named '' in the templateContext section.
parameters:
- name: targetOsArch
  type: string
- name: imageVersion
  type: string
- name: config
  type: string
steps:
- task: Docker@2
  displayName: Login to ACR
  inputs:
    command: login
    containerRegistry: doclient-dockercontainerregistry-buildpipeline
    repository: $(parameters.targetOsArch)
- task: Docker@2
  displayName: Pull latest build image
  inputs:
    command: pull
    containerRegistry: doclient-dockercontainerregistry-buildpipeline
    arguments: 'doclientcontainerregistry.azurecr.io/${{parameters.targetOsArch}}:${{parameters.imageVersion}}'
- task: CmdLine@2
  inputs:
    script: 'sudo docker run --rm --privileged multiarch/qemu-user-static --reset -p yes'
  displayName: Enable the build VM to run multiarch docker container
- task: CmdLine@2
  inputs:
    script: 'sudo docker run --rm --entrypoint=/bin/bash -v $(Build.SourcesDirectory):/code -v /tmp/build-deliveryoptimization-plugin-apt-${{parameters.targetOsArch}}:/tmp/build-deliveryoptimization-plugin-apt doclientcontainerregistry.azurecr.io/${{parameters.targetOsArch}}:${{parameters.imageVersion}} "/code/build/docker/docker-build-plugin.sh" "/code" "${{parameters.config}}"'
  displayName: 'Build deliveryoptimization-plugin-apt ${{parameters.targetOsArch}}-${{parameters.config}}'
- task: CopyFiles@2
  inputs:
    SourceFolder: '/tmp/build-deliveryoptimization-plugin-apt-${{parameters.targetOsArch}}/linux-${{parameters.config}}'
    Contents: |
      deliveryoptimization-plugin-apt*.deb
    TargetFolder: '$(Build.ArtifactStagingDirectory)/plugin-apt-${{parameters.targetOsArch}}-${{parameters.config}}'
    CleanTargetFolder: true
  displayName: 'Populate artifacts staging dir'
- task: CopyFiles@2
  condition: eq('${{parameters.config}}', 'minsizerel')
  inputs:
    SourceFolder: '/tmp/build-deliveryoptimization-plugin-apt-${{parameters.targetOsArch}}/linux-${{parameters.config}}'
    Contents: |
      plugins/linux-apt/deliveryoptimization-plugin-apt.dbg
    TargetFolder: '$(Build.ArtifactStagingDirectory)/plugin-apt-${{parameters.targetOsArch}}-${{parameters.config}}'
  displayName: 'Populate debug symbols to staging dir'