# Template: Jobs to build DO projects using docker to target non-native OS and/or architecture.
# Consume this jobs template in a pipeline yaml by passing in parameter values.

parameters:
- name: targetOsArch    # example: ubuntu2004_arm64
  type: string
- name: imageVersion
  type: string
- name: stepsTemplate   # example: dopapt-docker-steps.yml
  type: string

jobs:
# Build agents are running x64 architecture, so we don't run unit tests for ARM builds (built using docker+QEMU).
# Build agents are currently running Ubuntu 18.04, so the tests are run only for Ubuntu 18.04 builds.
- job: ${{parameters.targetOsArch}}_debug
  steps:
  - template: ${{parameters.stepsTemplate}}
    parameters:
      targetOsArch: ${{parameters.targetOsArch}}
      imageVersion: ${{parameters.imageVersion}}
      config: debug
      skipTests: ${{ ne(parameters.targetOsArch, 'ubuntu1804_x64') }}
  - publish: $(Build.ArtifactStagingDirectory)
    artifact: 'doclient-drop-${{parameters.targetOsArch}}-debug'

- job: ${{parameters.targetOsArch}}_release
  steps:
  - template: ${{parameters.stepsTemplate}}
    parameters:
      targetOsArch: ${{parameters.targetOsArch}}
      imageVersion: ${{parameters.imageVersion}}
      config: minsizerel
      skipTests: true
  - publish: $(Build.ArtifactStagingDirectory)
    artifact: 'doclient-drop-${{parameters.targetOsArch}}-minsizerel'
