# This Yaml Document has been converted by ESAI Yaml Pipeline Conversion Tool.
# Please make sure to check all the converted content, it is your team's responsibility to make sure that the pipeline is still valid and functions as expected.
# The Task 'PublishBuildArtifacts@1' has been converted to an output named '' in the templateContext section.
parameters:
- name: targetOsArch
  type: string
- name: config
  type: string
- name: skipTests
  type: boolean
  default: false
steps:
- task: CmdLine@2
  inputs:
    script: 'python3 ./build.py --project agent --config ${{parameters.config}} --package-for DEB --clean'
    workingDirectory: '$(Build.SourcesDirectory)/build'
  displayName: 'Build agent ${{parameters.targetOsArch}}-${{parameters.config}}'
- task: Bash@3
  condition: eq('${{parameters.config}}', 'minsizerel')
  inputs:
    targetType: 'filePath'
    filePath: 'build/scripts/check_binary_size.sh'
    arguments: '523672 /tmp/build-deliveryoptimization-agent/linux-${{parameters.config}}/client-lite/deliveryoptimization-agent'
  displayName: 'Limit binary size increase'
- task: CmdLine@2
  condition: eq('${{parameters.skipTests}}', false)
  inputs:
    script: 'sudo dpkg -i deliveryoptimization-agent*.deb'
    workingDirectory: '/tmp/build-deliveryoptimization-agent/linux-${{parameters.config}}'
  displayName: 'Install agent Debian package'
- task: CmdLine@2
  condition: eq('${{parameters.skipTests}}', false)
  inputs:
    script: './client-lite/test/deliveryoptimization-agent-tests --gtest_filter=-NetworkMonitorTests*'
    workingDirectory: '/tmp/build-deliveryoptimization-agent/linux-${{parameters.config}}/'
  displayName: 'Run unit tests'
- task: CmdLine@2
  condition: eq('${{parameters.skipTests}}', false)
  inputs:
    script: 'sudo dpkg -r deliveryoptimization-agent'
    workingDirectory: '/tmp/build-deliveryoptimization-agent/linux-${{parameters.config}}'
  displayName: 'Remove Debian package'
- task: CopyFiles@2
  inputs:
    SourceFolder: '/tmp/build-deliveryoptimization-agent/linux-${{parameters.config}}'
    Contents: |
      deliveryoptimization-agent*.deb
    TargetFolder: '$(Build.ArtifactStagingDirectory)/${{parameters.targetOsArch}}-${{parameters.config}}'
    CleanTargetFolder: true
  displayName: 'Populate artifacts staging dir'
- task: CopyFiles@2
  condition: eq('${{parameters.config}}', 'minsizerel')
  inputs:
    SourceFolder: '/tmp/build-deliveryoptimization-agent/linux-${{parameters.config}}'
    Contents: |
      client-lite/deliveryoptimization-agent.dbg
    TargetFolder: '$(Build.ArtifactStagingDirectory)/${{parameters.targetOsArch}}-${{parameters.config}}'
  displayName: 'Populate debug symbols to staging dir'
- task: CopyFiles@2
  condition: eq('${{parameters.skipTests}}', false)
  inputs:
    SourceFolder: '/tmp/build-deliveryoptimization-agent/linux-${{parameters.config}}'
    Contents: |
      client-lite/test/deliveryoptimization-agent-tests
    TargetFolder: '$(Build.ArtifactStagingDirectory)/${{parameters.targetOsArch}}-${{parameters.config}}'
    CleanTargetFolder: false
  displayName: 'Populate artifacts staging dir with test binary'